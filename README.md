# ğŸ† åä¸ºæ˜‡æ€æŒ‘æˆ˜èµ›-å¤§æ¨¡å‹æ¨ç†è°ƒä¼˜èµ›é“é‡‘å¥–æ–¹æ¡ˆ

**è·å¥–æ’å**ï¼šTop 1 é‡‘å¥–è·å¾—è€… ç¾æ»‹æ»‹å­¦ç¼–ç¨‹ ï¿¥110000| **å‚èµ›æ—¶é—´**ï¼š2024å¹´6æœˆ-2024å¹´12æœˆ

**æŠ€æœ¯é¢†åŸŸ**ï¼šå¤§æ¨¡å‹æ¨ç†ä¼˜åŒ– Â· æœåŠ¡ç«¯è°ƒåº¦ Â· æ¨¡å‹é‡åŒ–å‹ç¼© Â· é«˜æ€§èƒ½è®¡ç®—

## ğŸ“Œ é¡¹ç›®èƒŒæ™¯
æœ¬é¡¹ç›®ä¸º2024å¹´åä¸ºæ˜‡æ€MindSporeæ¨¡å‹å¼€å‘æŒ‘æˆ˜èµ›æ¨ç†è°ƒä¼˜èµ›é¢˜çš„é‡‘å¥–ä½œå“ï¼Œé’ˆå¯¹å¤§è¯­è¨€æ¨¡å‹æœåŠ¡ç«¯æ¨ç†åœºæ™¯ï¼ŒåŸºäºMindSporeæ¡†æ¶å®ç°äº†ä»æ¨¡å‹ä¼˜åŒ–åˆ°éƒ¨ç½²è½åœ°çš„å®Œæ•´æ¨ç†åŠ é€Ÿæ–¹æ¡ˆã€‚é€šè¿‡ç³»ç»Ÿçº§çš„æ€§èƒ½è°ƒä¼˜ï¼Œåœ¨ä¿è¯æ¨¡å‹ç²¾åº¦çš„å‰æä¸‹ï¼Œ**æ¨ç†é€Ÿåº¦ç›¸æ¯”baselineæå‡27å€**ï¼Œæœ€ç»ˆä»¥**å®Œæˆå…¨éƒ¨æ¨ç†è¯·æ±‚è€—æ—¶æœ€çŸ­**è·å¾—èµ›é“æœ€é«˜å¥–é¡¹ã€‚

**æ¯”èµ›å®˜ç½‘**ï¼š[æ˜‡æ€MindSporeæ¨¡å‹å¼€å‘æŒ‘æˆ˜èµ›ã€æ¨ç†è°ƒä¼˜èµ›é¢˜ã€‘](https://www.hiascend.com/developer/contests/details/c40cacdb4fa347bd8b378ad881e1e80e?module=52d78eec65a74fc8b9688a750a6b9d0f)  

**è·å¥–å…¬ç¤º**ï¼š[è·å¥–åå•å…¬ç¤º](https://www.hiascend.com/developer/contests/details/c40cacdb4fa347bd8b378ad881e1e80e?module=c182bd74e8054da3b3f2aadf0bd247d2)

![image-20250208110633093](image/image-20250208110633093.png)

## ğŸ”æ¨ç†è°ƒä¼˜èµ›é¢˜ä»‹ç»ä¸åˆ†æ

åœ¨Ascend 910b 32G|ARM:24æ ¸ 192GBä¸Šä½¿ç”¨performance_servingç¨‹åºæŒ‰ç…§å›ºå®šæ—¶é—´é—´éš”å‘é€1500æ¡æ¨ç†è¯·æ±‚ç»™llm-servringç¨‹åºï¼Œè®°å½•å®Œæˆæ¨ç†æ€»è€—æ—¶ï¼Œæ€»è€—æ—¶è¦æ±‚ä½äº600ç§’ï¼Œå¹¶ä¸”éœ€è¦å®Œæ•´çš„å‰åå¤„ç†æ¨ç†è¿‡ç¨‹å’Œlogitsç²¾åº¦æŸå¤±ä¸è¶…è¿‡åƒåˆ†ä¹‹äº”ã€‚

### æ•´ä½“å…³ç³»åˆ†æ

![image-20241116224839878](image/image-20241116224839878.png)

æ•´ä½“å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹baselineä¸­é‡‡ç”¨çš„ä¼˜åŒ–ç­–ç•¥å’Œæ”¯æŒå“ªäº›ä¼˜åŒ–ç®—æ³•ã€‚æŒæ¡è¿™äº›å†…å®¹å¯ä»¥æ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬æ˜ç¡®å¼€å‘ä¼˜åŒ–åŸºç¡€ï¼ŒçŸ¥é“å“ªäº›ä¼˜åŒ–å·²ç»å®Œæˆï¼Œå“ªäº›ä¼˜åŒ–å·²ç»å®ç°ä½†è¿˜æ˜¯éœ€è¦è°ƒæ•´æœ€ä½³å‚æ•°æ‰èƒ½å‘æŒ¥æœ€å¤§ä½œç”¨ï¼Œè¿˜æœ‰å“ªäº›ä¼˜åŒ–æ˜¯æš‚æ—¶è¿˜æ²¡æœ‰å®ç°çš„ã€‚

### Baselineç­–ç•¥åˆ†æ

baselineå·²ç»å…·å¤‡çš„ä¸€äº›ä¼˜åŒ–ç®—æ³•å®ç°æ¢³ç†ï¼š

mindformeræ¨ç†åç«¯ï¼š

* InferAttentionä½¿ç”¨äº†Flashattentionç®—æ³•
* ROPEé‡‡ç”¨äº†é¢„å…ˆè®¡ç®—ï¼Œå­˜å…¥cacheæ“ä½œï¼Œæ¨ç†è¿‡ç¨‹ä¸­ç›´æ¥å–å€¼ï¼Œå‡å°‘è®¡ç®—é‡
* é™æ€å›¾ï¼ŒåŠ å¿«æ¨ç†é€Ÿåº¦

* æ”¯æŒPagedattentionç®—æ³•ï¼ŒKVcacheçš„å­˜æ”¾æ›´åŠ çµæ´»

llm-servingæœåŠ¡è°ƒåº¦ç«¯ï¼š

* Fastapiå¼‚æ­¥å¤„ç†httpæ¨ç†è¯·æ±‚
* decodingé˜¶æ®µå¤šbatchæ¨ç†ï¼Œä½†æ˜¯ä¸æ”¯æŒprefillé˜¶æ®µbatchsizeæ¨ç†ã€‚
* Continuous batchingï¼Œæ¯æ¬¡è¿­ä»£æ¨ç†åé‡æ–°è°ƒåº¦ç»„batchï¼Œå¯ä»¥å¤§å¹…æå‡LLMæœåŠ¡çš„ååé‡ã€‚

baselineé€‰æ‹©æœ€ç›´æ¥çš„æ¨ç†æ–¹å¼ï¼Œprefillå’Œdecodingé˜¶æ®µçš„batchsizeéƒ½æ˜¯1ï¼Œå³æ¯æ¬¡æ¨ç†åªèƒ½è°ƒç”¨çš„æ¨ç†è¯·æ±‚åªèƒ½å®Œæˆä¸€ä¸ªæ¨ç†è¯·æ±‚çš„ä¸€ä¸ªtokenè¾“å‡ºã€‚æ‰€æœ‰çš„è¯·æ±‚éœ€è¦1500æ¡è¯·æ±‚çš„è¾“å‡ºtokenæ€»æ•°æ¬¡æ¨ç†è°ƒç”¨ï¼Œæ‰èƒ½å®Œæˆå…¨éƒ¨çš„æ¨ç†ä»»åŠ¡ï¼Œæ‰€ä»¥æ•´ä½“çš„è€—æ—¶ä¼šå¾ˆé•¿ã€‚

### è§£é¢˜æ€è·¯ä¼˜åŒ–ç­–ç•¥ç›˜ç‚¹ä¸å¯è¡Œæ€§åˆ†æ

* æ¨¡å‹æœ¬èº«ï¼Œåå¤„ç†ä¸æ¨¡å‹å¤„ç†èåˆï¼Œå‡å°‘æ¨¡å‹æ¨ç†è¾“å…¥æ•°æ®é‡ï¼Œç›´æ¥å°†åå¤„ç†ä¸æ¨¡å‹æ¨ç†èåˆï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚
* æ¨ç†åç«¯ï¼Œé‡‡ç”¨ä¸€äº›flashattentionã€pagedattentionç­‰ç”¨æ³•ï¼Œé™æ€å›¾æ¨ç†
* æœåŠ¡è°ƒåº¦ï¼Œå¤šbatchæ¨ç†ã€ä»»åŠ¡ä¼˜å…ˆçº§

é¦–å…ˆçœ‹é‡åŒ–ç­–ç•¥åˆ†æï¼Œè¯´åˆ°æ¨ç†åŠ é€Ÿï¼Œå¾ˆå¤šåŒå­¦å¯èƒ½ä¼šæƒ³åˆ°å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ï¼Œä»è€Œå®ç°åŠ é€Ÿæ¨ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é‡åŒ–ç­–ç•¥çš„å¯è¡Œæ€§åˆ†æã€‚

#### **é‡åŒ–ç­–ç•¥åˆ†æï¼š**

**weight onlyé‡åŒ–æ–¹å¼**ï¼šGPTQã€AWQç­‰ç®—æ³•ï¼Œåªèƒ½å‡å°‘æ¨¡å‹åŠ è½½æ—¶é—´ï¼Œæ¨ç†è¿‡ç¨‹ä¸­æƒé‡éœ€è¦åé‡åŒ–ï¼Œä½†æ˜¯å®é™…è®¡ç®—ä»ç„¶æ˜¯fp16ç±»å‹ï¼Œå¹¶ä¸”åé‡åŒ–çš„è®¡ç®—ä¸batchsizeæœ‰å…³ç³»ï¼Œåªèƒ½å‡å°‘å†…å­˜å ç”¨ï¼Œå¹¶ä¸èƒ½åŠ å¿«æ¨ç†é€Ÿåº¦ï¼Œä¸é€‚åˆæœåŠ¡ç«¯æ¨ç†ã€‚

**çŸ©é˜µä¹˜æ³•é‡åŒ–**ï¼šå°†linearæƒé‡å’Œæ¿€æ´»å€¼éƒ½è¿›è¡Œint8é‡åŒ–ï¼ŒGemmçš„å®ç°æ›¿æ¢ä¸ºint8å®ç°ï¼Œäº‹å…ˆå¯¹æƒé‡è¿›è¡Œé‡åŒ–ï¼Œæ¿€æ´»å€¼å‰åè¦æ’å…¥é‡åŒ–ä¸åé‡åŒ–ç®—å­ï¼Œä¼šåŠ å¿«æ¨ç†é€Ÿåº¦ï¼Œé€‚åˆç”¨åœ¨æœåŠ¡ç«¯ï¼Œä½†æ˜¯å¯èƒ½å¯¼è‡´ç²¾åº¦æŸå¤±è¶…æ ‡ã€‚

**KVcacheé‡åŒ–**ï¼šå°†KVcacheè¿›è¡Œé‡åŒ–ï¼Œç”±FP16é‡åŒ–ä¸ºint8å‚¨å­˜ï¼Œè¿›è¡Œè®¡ç®—æ—¶ï¼Œå†åé‡åŒ–åˆ°fp16ï¼Œé€‚ç”¨äºæ˜¾å­˜ç©ºé—´å—é™çš„æœåŠ¡ç«¯ï¼Œå¯ä»¥åŠ å€æå‡ç”¨æˆ·æ‰¿è½½é‡ã€‚ä¸é€‚åˆæˆ‘ä»¬å½“å‰çš„åœºæ™¯ï¼Œæˆ‘ä»¬çš„æ¨ç†è¯·æ±‚ç›¸å¯¹æ¥è¯´ä¸é•¿ï¼Œå¹¶ä¸”ä½¿ç”¨äº†pagedattentionè¿›è¡Œç®¡ç†KVcacheï¼Œç›®çš„æ˜¯å¿«é€Ÿå®Œæˆæ¨ç†è€Œä¸æ˜¯å¢åŠ æœåŠ¡ä¸­åŒæ—¶æ‰¿è½½çš„ç”¨æˆ·æ•°ã€‚

æ‰€ä»¥é‡åŒ–ç­–ç•¥ç›´æ¥passæ‰ï¼Œè¿™éƒ¨åˆ†çš„ä¼˜åŒ–å…ˆä¸å»è€ƒè™‘ã€‚

#### **æ¥ä¸‹æ¥è€ƒè™‘æ¨¡å‹æ¨ç†é€Ÿåº¦çš„ä¼˜åŒ–**ï¼š

* FlashAtentionç®—æ³•ã€PAç®—æ³•ã€RMSNormã€ROPEç®—å­ã€é™æ€å›¾æ¨ç†éƒ½å·²ç»é«˜æ•ˆå®ç°åœ¨mindformerä¸­

* é‡‡æ ·é˜¶æ®µçš„è´ªå©ªæœç´¢åå¤„ç†ä¼˜åŒ–ï¼Œå€¼å¾—å»åš

* warmupé¢„çƒ­æ¨ç†å¼•æ“ã€‚

* qkv ffn linear åˆå¹¶è®¡ç®—

çœŸæ­£èƒ½å¸¦æ¥å¤„ç†æ•ˆç‡çš„ç­–ç•¥åŸºæœ¬ä¸Šéƒ½æ˜¯æœåŠ¡è°ƒåº¦ç›¸å…³çš„å†…å®¹ï¼Œä¼˜ç§€çš„è°ƒåº¦batchç­–ç•¥ç›¸æ¯”ä¼ ç»Ÿçš„é™æ€batchç­–ç•¥æå‡è¾¾åˆ°å¥½å‡ åå€ã€‚

#### **æœåŠ¡è°ƒåº¦ä¼˜åŒ–**ï¼š

* batchsizeçš„prefillæ¨ç†

* æ ¹æ®æ•°æ®é›†è°ƒæ•´seq_lené•¿åº¦

* è°ƒæ•´è¯·æ±‚ä»»åŠ¡ä¼˜å…ˆçº§

* å®Œæ•´çš„Continuous batchingåŒ…æ‹¬ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä»¥å•ä¸ªtokenç”Ÿæˆä¸ºstepè¿›è¡Œbatchingç­–ç•¥ï¼Œå¦ä¸€ä¸ªç‚¹å°±æ˜¯ORCAç­–ç•¥ã€‚llm-servingå®ç°çš„continute batchingç­–ç•¥ï¼Œåªå®ç°äº†ç¬¬ä¸€ä¸ªç‚¹ï¼Œè€Œæ²¡æœ‰å®ç°ç¬¬äºŒä¸ªç‚¹ã€‚

ä»¥ä¸Šå°±æ˜¯æˆ‘çš„è§£é¢˜æ€è·¯ï¼Œç¡®å®šå¥½è¦åšçš„ä¼˜åŒ–ç­–ç•¥ï¼Œç„¶åå°±å»å®è·µã€‚

## ğŸ› ï¸ä¼˜åŒ–featureå®ç°

### â­ï¸prefillé˜¶æ®µbatchsizeæ¨ç†

æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œåœ¨è°ƒåº¦å®Œæˆåä»running listæŒ‘é€‰ä»»åŠ¡çš„æ—¶å€™ï¼Œå¯¹prefillé˜¶æ®µä»»åŠ¡çš„é€‰æ‹©å¼€å§‹ï¼Œåœ¨æ­¤å¤„å®Œæˆé€‚é…prefillå¤šbatchçš„å¼€å‘å·¥ä½œã€‚

å¼€å‘å®Œæˆ-å¢åŠ æ¨ç†æœåŠ¡ååé‡ï¼Œåœ¨llmservingçš„åŸºç¡€ä¸Šï¼ŒåŸå…ˆåªæ”¯æŒdecodingçš„batchsizeæ¨ç†ï¼Œç°åœ¨å®Œå–„äº†å¤šbatchçš„prefillé˜¶æ®µçš„æ¨ç†ï¼Œå¤§å¹…æå‡æ¨ç†ååé‡ã€‚

### â­ï¸åå¤„ç†ä¸æ¨¡å‹æ¨ç†èåˆ

å°†æ¨¡å‹çš„logitsè¾“å‡ºï¼Œç›´æ¥è¿›è¡Œargmaxè®¡ç®—ï¼Œè€Œä¸æ˜¯å°†logitsä¼ å‡ºï¼Œç„¶åå†ä¼ å…¥è¿›è¡Œè®¡ç®—ï¼Œå¤§å¤§å¢åŠ äº†æ•ˆç‡ã€‚é¿å…å°†batchsizeï¼Œvocab_sizeçš„æ•°æ®æ¬è¿å‡ºå»ï¼Œè€Œæ˜¯ç›´æ¥å°†åå¤„ç†å®ç°åœ¨æ¨¡å‹æ¨ç†è¿‡ç¨‹ä¸­ï¼Œå°†åå¤„ç†ä¸æ¨¡å‹æ¨ç†èåˆä¸€èµ·ç”¨é™æ€å›¾æ¨ç†å®Œæˆã€‚

```python
ä¿®æ”¹/home/ma-user/work/mindformers/mindformers/models/llama/llama.py ä»£ç ï¼Œåœ¨LlamaForCausalLM forwardå‡½æ•°ä¸Šè¡¥å……è´ªå©ªæœç´¢ç­–ç•¥é€»è¾‘
        logits = self.cast(logits, mstype.float32)
        indices, max_values = self.argmax_with_value(logits)# è®¡ç®—æ¯è¡Œçš„æœ€å¤§å€¼å’Œå¯¹åº”çš„ç´¢å¼•
        indices = P.Cast()(indices, mstype.int32)
        if not self.training:
            return indices, max_values
```

å¾—åˆ°çš„ç»“æœå°±æ˜¯è¯è¡¨çš„ç´¢å¼•å’Œå¯¹åº”çš„å€¼ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†ç»“æœå†™å…¥åˆ°å…±äº«å†…å­˜ä¸­ï¼Œè€Œä¸éœ€è¦å†æ¬¡è¿›è¡Œè®¡ç®—ã€‚

```python
    def handle_inference_results(self,outputs, outputs_shm, output_logprob_shm, decode_index, prefill=True):
        # self.targets.clear()
        indices=outputs[0]
        max_values=outputs[1]
        # è®°å½•ç´¢å¼•å’Œå¯¹åº”çš„æœ€å¤§å€¼æ—¥å¿—
        logging.info("handle_inference_results indices type is {}, value is {}".format(indices.dtype, indices))
        logging.info("handle_inference_results max_values type is {}, value is {}".format(max_values.dtype, max_values))
        indices=indices.asnumpy().reshape(-1)
        max_values=max_values.asnumpy().reshape(-1)
        # å½“ rank_id ä¸º 0 æ—¶ï¼Œå°†æ•°æ®å†™å…¥å…±äº«å†…å­˜
        if self.rank_id == 0:
            if prefill:
                for index in decode_index:
                    tmp = np.ndarray((index + self.current_batch_size,), dtype=indices.dtype, buffer=outputs_shm.buf)
                    tmp[index: index + self.current_batch_size] = indices[:]


                    tmp_logprob = np.ndarray((index + self.current_batch_size,), dtype=np.float64,
                                             buffer=output_logprob_shm.buf)
                    tmp_logprob[index: index + self.current_batch_size] = max_values[:]

            else:
                # éé¢„å¡«å……æ¨¡å¼
                tmp = np.ndarray((self.current_batch_size,), dtype=indices.dtype, buffer=outputs_shm.buf)
                tmp[:] = indices[:]
                # å°†å¯¹åº”çš„æœ€å¤§å€¼å†™å…¥å…±äº«å†…å­˜
                tmp_logprob = np.ndarray((self.current_batch_size,), dtype=np.float64, buffer=output_logprob_shm.buf)
                tmp_logprob[:] = max_values[:]

```



### â­ï¸æ ¹æ®æ•°æ®é›†è°ƒæ•´seq_len

æˆ‘åœ¨ä¸€é˜¶æ®µå¼€æºçš„æŠ¥å‘Šä¸­å°±é€šè¿‡åˆ†ææ•°æ®é›†ï¼Œè·å–åˆ°äº†æœ€é•¿çš„tokenå¥å­ï¼Œæ‰¾åˆ°æœ€ä½³çš„seq_lené•¿åº¦çš„é…ç½®ï¼Œæ ¹æ®ä¸åŒçš„batchsizeæƒ…å†µåŠ¨æ€è°ƒæ•´seq_lené•¿åº¦ï¼Œå¯ä»¥å‡å°‘æ¨ç†è¿‡ç¨‹ä¸­æ— ç”¨çš„å¡«å……é•¿åº¦ï¼Œå¢åŠ æ¨ç†é€Ÿåº¦ã€‚

![image-20241118104216085](image/image-20241118104216085.png)

æµ‹é€Ÿæ•°æ®é›†çš„æœ€å¤§è¾“å‡ºé•¿åº¦ä¸º504ï¼Œç²¾åº¦æ•°æ®é›†æœ€å¤§çš„è¾“å‡ºé•¿åº¦ä¸º464.

### â­ï¸ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦

æœ€å¸¸è§çš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥æ˜¯FCFSç­–ç•¥ï¼Œå°±æ˜¯è¯´è°å…ˆåˆ°ï¼Œå…ˆæœåŠ¡è°ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§æ—¶é—´é¡ºåºæ’åºã€‚é™¤äº†æ—¶é—´é¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿä¸€ä¸‹ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ç»“æ„ä½“ï¼Œçœ‹å¯ä»¥é€‰æ‹©å“ªäº›å˜é‡ä½œä¸ºä¼˜å…ˆçº§çš„é€‰æ‹©ä¾æ®ã€‚

![image-20241118092523730](image/image-20241118092523730.png)

å¯ä»¥çœ‹å‡ºï¼Œå¤§å¤šæ•°éƒ½æ˜¯æ¨ç†ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€è®°å½•ï¼Œå¯ä»¥ä½œä¸ºä¼˜å…ˆçº§é€‰æ‹©çš„ä¸€ä¸ªæ˜¯prompté•¿åº¦ï¼Œå¦ä¸€ä¸ªæ˜¯maxTokenLenè¯·æ±‚è¦æ±‚è¾“å‡ºçš„é•¿åº¦ã€‚

åœ¨è®­ç»ƒåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸é€‰æ‹©prompté•¿åº¦æ¥è¿‘çš„å‡ ä¸ªè¾“å…¥ç»„æˆbatchè¿›è¡Œè®­ç»ƒè¿™æ ·å¯ä»¥å‡å°‘paddingå¡«å……é‡ï¼Œä½†æ˜¯åœ¨æ¨ç†ç«¯é€šå¸¸é‡‡ç”¨çš„æ˜¯FCFSç­–ç•¥ï¼Œæ‰€ä»¥ä¼šå°†å‡ ä¸ªè¾“å…¥ç›´æ¥ç»„æˆbatchï¼Œç„¶åpaddingåˆ°æŒ‡å®šé•¿åº¦è¿›è¡Œæ¨ç†ã€‚æ—¢ç„¶è¦paddingï¼Œå…¶å®æ ¹æ®è¯·æ±‚é•¿åº¦å®‰æ’ä¼˜å…ˆçº§æ„ä¹‰å¹¶ä¸å¤§ã€‚

ç„¶åå†çœ‹å¦ä¸€ä¸ªmaxTokenLenè¯·æ±‚è¦æ±‚è¾“å‡ºçš„é•¿åº¦ï¼Œæœ¬æ¬¡æ¯”èµ›ä¸­ï¼Œæ¨ç†è¯·æ±‚çš„è¾“å‡ºtokenä¸ªæ•°æ˜¯å·²çŸ¥çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ ¹æ®è¾“å‡ºè¯·æ±‚çš„tokenæ•°é‡å¤§å°ï¼Œç»™è¿™äº›æ¨ç†ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€‚æ—¢ç„¶å·²ç»çŸ¥é“æ¨ç†çš„tokenæ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä¼˜å…ˆå®Œæˆé‚£äº›tokenç”Ÿæˆæ•°æ¯”è¾ƒå¤šçš„è¯·æ±‚çš„prefillé˜¶æ®µï¼Œé‚£ä¹ˆåœ¨åç»­batchsizeä¸º128çš„decodingè¯·æ±‚ä¸­ï¼Œæœ‰æ•ˆçš„æ§½ä½æ‰ä¼šæ›´å¤šï¼ŒNPUçš„åˆ©ç”¨ç‡ä¹Ÿå°±éå¸¸å¤§ã€‚

é€šè¿‡å¯¹æ¯”è¯•éªŒè¯´æ˜ï¼šåœ¨520seqlenå¥å­é•¿åº¦ä¸‹ï¼Œå°†è¾“å…¥æ’åºï¼Œä¼˜å…ˆå¤„ç†è¾“å‡ºå°‘çš„è¯·æ±‚æ—¶ï¼Œè¦æ¯”æ— åºçŠ¶æ€å¿«30ç§’ï¼Œè€Œä¼˜å…ˆå¤„ç†é•¿tokençš„è¯·æ±‚ï¼Œè¦å†æ¬¡åŸºç¡€ä¸Šå†å¿«20ç§’ã€‚

å¦‚æœæ˜¯åœ¨4096å¥å­é•¿åº¦ä¸‹ï¼Œåˆ†åˆ«å¿«40ç§’å’Œ65ç§’.

å¯¹æ¯”å®éªŒæ•°æ®è¯´æ˜ä¸åŒç­–ç•¥çš„æ¨ç†æ¬¡æ•°å·®å¼‚ï¼Œç”±äºä»£é‡‘åˆ¸ç”¨å®Œäº†ï¼Œæ‰€ä»¥æ²¡åŠæ³•æŠŠè¿™ä¸ªå¯¹æ¯”å®éªŒé‡æ–°è·‘ä¸€éã€‚



### â­ï¸warmupé¢„çƒ­æ¨ç†å¼•æ“

åœ¨å¾ˆå¤šæ¨ç†æ¡†æ¶ä¸­ï¼Œéƒ½ä¼šåœ¨è¿›è¡Œæ¨ç†æœåŠ¡å‰å¯¹æ¨ç†è¿›è¡Œwarmupé¢„çƒ­ï¼Œæ¯”å¦‚FasterTransformerå°±ä¼šå¯¹æ¨¡å‹è¿›è¡Œä¸€æ¬¡æ¨ç†é¢„çƒ­ï¼Œåœ¨vllmä¸­ï¼Œé¢„çƒ­å¼•æ“ä¼šè°ƒç”¨cuda graphå¯¹ä¸åŒbatchsizeçš„è¾“å…¥è¿›è¡Œé¢„çƒ­ï¼Œç„¶åå†å»æ‰§è¡Œå¯¹åº”çš„æ¨ç†ä»»åŠ¡ã€‚

é€šè¿‡æŸ¥çœ‹æ—¥å¿—ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ¨ç†å¼•æ“çš„æ—¶é—´é€šå¸¸ä¼šä¹…ä¸€äº›ï¼Œå¦‚æœäº‹å…ˆç¼–å†™ä¸€ä¸ªç©ºç™½è¾“å…¥è¿›è¡Œä¸€æ¬¡æ¨¡æ‹Ÿçš„å‰å‘æ¨ç†ï¼Œæœ‰åˆ©äºæå‡æ¨ç†æœåŠ¡æ•´ä½“çš„æ•ˆç‡ã€‚

é€šè¿‡å¯¹äºmindformerçš„é¢„å…ˆè°ƒç”¨ï¼Œå‡å°‘ç¬¬ä¸€æ¬¡è°ƒç”¨çš„é¢å¤–è€—æ—¶ã€‚

```python
    def warmup_and_multiPrefill(self,cfg:ServingConfig):
        batchsize = cfg['model_config']['prefill_batch_size'][0]
        seq_len = cfg['model_config']['seq_length'][0]
        input_ids = np.array([
        [1, 2, 3, 4, 5, 6, 7, 8] + [0] * (seq_len - 8)
        ] * batchsize, dtype=np.int64)
        valid_length_each_example = np.array([8] * batchsize, dtype=np.int64)
        current_index = np.array([7] * batchsize, dtype=np.int64)
        block_tables = np.array([
        [0] + [-1] * (256 - 1)
        for i in range(batchsize)
        ], dtype=np.int32)
        slot_mapping = np.array(list(range(10)) + [-1] * (seq_len*batchsize - 10), dtype=np.int32)
        model_kwargs = {"current_index": current_index}
        self.mindspore_model.is_first_iteration = True
        # self.mindspore_model.config.batch_size=4
        res, current_index = self.mindspore_model.forward(input_ids=input_ids,
                                                valid_length_each_example=valid_length_each_example,
                                                generation_config=self.mindspore_model.config,
                                                block_tables=block_tables,
                                                slot_mapping=slot_mapping,
                                                prefill=True,
                                                **model_kwargs)
```



### â­ï¸é’ˆå¯¹qkvå’Œffnæƒé‡è¿›è¡Œæ‹¼æ¥ï¼Œåˆå¹¶Gemmè¿ç®—

å¯¹qkvçš„weightè¿›è¡Œåˆå¹¶ä»¥åï¼Œåªéœ€è¦è°ƒç”¨ä¸€æ¬¡Gemmè¿ç®—ï¼Œå°±å¯ä»¥å®Œæˆä¸‰ä¸ªçŸ©é˜µçš„è¿ç®—ï¼Œå‡å°‘äº†Gemmè¿ç®—è°ƒç”¨çš„æ¬¡æ•°ï¼Œffnå±‚çš„gateå’Œup linearçš„æ‹¼æ¥ä¹Ÿæ˜¯åŒç†ã€‚

```
X (N, d_input)
â”œâ”€â”€ W_Q (d_input, d_output) â†’ Q (N, d_output)
â”œâ”€â”€ W_K (d_input, d_output) â†’ K (N, d_output)
â””â”€â”€ W_V (d_input, d_output) â†’ V (N, d_output)

X (N, d_input)
â””â”€â”€ W_{QKV} (d_input, 3 * d_output) â†’ X W_{QKV} (N, 3 * d_output)
                         â””â”€â”€ split(3) â†’ [Q, K, V] (N, d_output)
```

ä»£ç å®ç°ï¼š

```python
        if self.qkv_concat:
            self.w = Linear(in_channels=self.hidden_size,
                            out_channels=self.hidden_size + self.kv_dim * 2,
                            has_bias=qkv_has_bias,
                            compute_dtype=compute_dtype,
                            param_init_type=param_init_type,
                            skip_redistribution=is_dynamic)
            self.w.shard(((dp, 1), (mp, 1)))
            
        if self.ffn_concat:
            self.w_gate_hidden = Linear(in_channels=dim,
                                        out_channels=hidden_dim * 2,
                                        expert_num=expert_num,
                                        outer_batch=dp_moe,
                                        has_bias=False,
                                        compute_dtype=compute_dtype,
                                        param_init_type=param_init_type,
                                        skip_redistribution=is_dynamic)
            self.activate = self.hidden_act()
            self.split = ms.ops.auto_generate.SplitWithSize()
            self.w2 = Linear(in_channels=hidden_dim,
                             out_channels=dim,
                             expert_num=expert_num,
                             outer_batch=dp_moe,
                             has_bias=False,
                             compute_dtype=compute_dtype,
                             param_init_type=param_init_type,
                             skip_redistribution=is_dynamic)
```

### â­ï¸ä¸€äº›é›¶ç¢çš„ä¼˜åŒ–ç‚¹å’Œbug fix

#### ä»»åŠ¡æœªèƒ½æ­£å¸¸ç»“æŸ

```python
    /home/ma-user/work/llm-serving/mindspore_serving/server/llm_server_post.py
    async def _master_abort(self, request_ids):
        logging.debug(f"Master abort called with request_ids type: {type(request_ids)}, value: {request_ids}")
        # self.master.abort_request(request_ids)
        for request_id in request_ids:
            self.master.abort_request(request_id)
```

è¯·æ±‚å®Œæˆåï¼Œå°†ä¼ é€’ç»™schedulerä¸­çš„è¿›è¡Œå¤„ç†ï¼Œè®¾ç½®ä¸ºåœæ­¢çŠ¶æ€ã€‚

```python
    def abort_entry(self,
                    request_id: str):
        for index, data in enumerate(self.running_request_list):
            if data.request_id == request_id:
                self.running_request_list[index].get_entry_data().set_status(EntryStatus.FINISHED_STOPPED)
```

ä½†æ˜¯ä¼ é€’è¿›æ¥çš„æ˜¯ä¸€ä¸ªsetå¯¹è±¡ï¼Œéœ€è¦å¾ªç¯å»è°ƒç”¨ã€‚

æ²¡æœ‰åŠæ—¶å°†è¿™äº›è¯·æ±‚è®¾ç½®ä¸ºå®ŒæˆçŠ¶æ€ï¼Œä¸‹ä¸€æ¬¡è°ƒåº¦æ¨ç†å°±ä»ç„¶ä¼šå†æ¬¡è¿›è¡Œï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å·²ç»æ¨ç†å®Œæˆçš„è¯·æ±‚å¤šæ¨ç†ä¸€æ¬¡ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è¶…è¿‡ç”Ÿæˆtokençš„é™åˆ¶æ—¶ï¼Œè®¾ç½®å¯¹åº”çš„ç»“æŸçŠ¶æ€ï¼Œæ‰ä¼šè¢«ç§»é™¤runningé˜Ÿåˆ—ã€‚

#### ä¸€äº›æ•°æ®ç±»å‹è½¬æ¢ä¸Šçš„ä¼˜åŒ–

æ•°æ®ç²¾åº¦çš„åå¤è½¬æ¢ï¼Œç¨‹åºä¸­æœ‰å¾ˆå¤šæ•°æ®ç±»å‹ä¸Šçš„è½¬æ¢ã€‚

ä¾‹å¦‚

æ¨ç†è¿‡ç¨‹ä¸­`self.kbk_targets = np.full((decode_batch_size, seq_length), self.config.model_config.pad_token_id)`

åˆå§‹åŒ–å®Œæ˜¯int64,åº”è¯¥æ˜¯int32ç±»å‹ã€‚input_idsç¬¬ä¸€æ¬¡è¾“å…¥æ˜¯int32ç±»å‹çš„ï¼Œåœ¨æ‰“å¹³çš„æ—¶å€™ï¼ŒæŠŠæ•°æ®æ ¼å¼ç”±int32è½¬ä¸ºfloat64äº†ï¼Œä»£ç åº”è¯¥è¿™ä¹ˆå†™ã€‚

```python
input_ids = np.concatenate((input_ids, np.zeros((input_ids.shape[0], seq_length - 1))), axis=1)

input_ids = np.concatenate((input_ids, np.zeros((input_ids.shape[0], seq_length - 1), dtype=np.int32)), axis=1)
```

ç±»ä¼¼é—®é¢˜å¾ˆå¤šï¼Œè¿™äº›é—®é¢˜éƒ½ä¼šå¯¼è‡´æ¨ç†è¿‡ç¨‹ä¸­çš„ä¸€äº›æ€§èƒ½æŸè€—ï¼Œè™½ç„¶è¿™äº›æ€§èƒ½æ¶ˆè€—å¯èƒ½ä¸ç®—å¤ªå¤§ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºæ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå¹¶ä¸”åœ¨debugçš„è¿‡ç¨‹ä¸­ï¼Œçœ‹ç€ä¸€ä¸ªå˜é‡çš„æ•°æ®ç²¾åº¦åå¤çš„å˜æ¥å˜å»ï¼Œæ¯”å¦‚è¿™ä¸ªinput_idsçš„æ•°æ®ç±»å‹æœ¬æ¥åº”è¯¥æ˜¯int32ï¼Œä½†æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸€ä¼šå„¿å˜æˆint64ä¸€ä¼šå„¿å˜æˆfp64ï¼Œåœ¨æ¨¡å‹æ¨ç†è¾“å…¥æ—¶åˆå˜ä¸ºäº†æœ€åˆæ•°æ®ç²¾åº¦ã€‚



#### RMSNormçš„weightæ•°æ®ç²¾åº¦ç±»å‹

åœ¨åŠ è½½æƒé‡è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡çœ‹åˆ°æ¨¡å‹çš„æƒé‡è®¾ç½®çš„æ•°æ®ç±»å‹å’Œæ–‡ä»¶çš„æ•°æ®ç²¾åº¦ä¸ä¸€è‡´æ‰“å°warningæ—¥å¿—ï¼Œéœ€è¦è¿›è¡Œå¯¹åº”ä¿®æ”¹ã€‚

```python
class LlamaRMSNorm(nn.Cell):
    def __init__(self, dim, eps=1e-6, compute_type=mstype.float32):
        super(LlamaRMSNorm, self).__init__()
        self.eps = eps
        self.compute_type = compute_type
        self.weight = Parameter(initializer('ones', (dim,), dtype=mstype.float32), parallel_optimizer=False) #dtype=compute_type
```



#### éå†æœ‰æ•ˆä»»åŠ¡

æ¯”å¦‚è¯´åœ¨æ‰§è¡Œè°ƒåº¦åï¼ŒæŸ¥çœ‹è°ƒåº¦ä»»åŠ¡åˆ—è¡¨æ˜¯å¦å­˜åœ¨æœ‰æ•ˆä»»åŠ¡ï¼Œæœ‰ä¸ªéå†æ“ä½œï¼Œéå†å®Œæ‰€æœ‰ä»»åŠ¡ç„¶åç»Ÿè®¡æœ‰æ•ˆä»»åŠ¡ä¸ªæ•°ï¼Œä¸ä¸º0ï¼Œé‚£å°±å¼€å§‹æ¨ç†ï¼Œä¸å­˜åœ¨æœ‰æ•ˆä»»åŠ¡åˆ™ç›´æ¥è¿”å›ã€‚

```python
class AsyncMaster(Master):
    # Master ç±»çš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œæ”¯æŒå¼‚æ­¥å¤„ç†æ¨ç†ä»»åŠ¡ã€‚
    async def step_async(self) -> List[ResponseOutput]:
        # è°ƒç”¨è°ƒåº¦å™¨çš„ _schedule() æ–¹æ³•è·å–ä»»åŠ¡å…ƒæ•°æ®åˆ—è¡¨ (entries_metadata_list) å’Œå½“å‰æ‰¹æ¬¡çš„å¤§å° (current_batch_size)ã€‚
        entries_metadata_list, current_batch_size = self._schedule()
        valid_entry_len = 0
        # æ£€æŸ¥æ¯ä¸ªç”Ÿæˆä»»åŠ¡çš„çŠ¶æ€ï¼Œç»Ÿè®¡å¤„äº RUNNING æˆ– INPUT_OUTOFRANGE çŠ¶æ€çš„ä»»åŠ¡æ•°é‡ã€‚
        for metadata in entries_metadata_list:
            # æ¨ç†è¿˜åœ¨è¿›è¡Œæˆ–è€…æç¤ºè¯é•¿åº¦è¶…å‡ºèŒƒå›´ï¼Œè¿™ä¸¤ä¸ªçŠ¶æ€ä¸‹çš„ä»»åŠ¡è®¡å…¥ valid_entry_len
            if metadata.entry_data.get_status() == EntryStatus.RUNNING or \
                    metadata.entry_data.get_status() == EntryStatus.INPUT_OUTOFRANGE:
                valid_entry_len += 1#é‚£ç›´æ¥å¯ä»¥ç›´æ¥breakå˜›ï¼Œæ²¡å¿…è¦ç®—å‡ºæ¥å¤šå°‘ä¸ªå¯ä»¥æ‰§è¡Œ
        # å¦‚æœå½“å‰æ‰¹æ¬¡ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ¨ç†ä»»åŠ¡ï¼ˆå³ valid_entry_len == 0ï¼‰ï¼Œåˆ™è¿”å› Noneï¼Œè¡¨ç¤ºæ²¡æœ‰å¯å¤„ç†çš„ä»»åŠ¡ã€‚
        if valid_entry_len == 0:
            return None
        # å¼‚æ­¥è°ƒç”¨ _run_workers_async æ‰§è¡Œæ¨ç†ä»»åŠ¡ï¼Œå¹¶è¿”å›æ¨¡å‹çš„æ¨ç†ç»“æœã€‚
        output = await self._run_workers_async(current_batch_size, entry_metadata_list=entries_metadata_list)
        return output
```

è¿˜æœ‰ä¸€äº›å…¶ä»–æ¯”è¾ƒå°çš„ä¼˜åŒ–ç‚¹å°±ä¸å†ä¸€ä¸€åˆ—ä¸¾äº†ã€‚

## ğŸ’¼æ€»ç»“

æ€»ç»“ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯ä¸¤å¤§éƒ¨åˆ†å†…å®¹ï¼Œä¸€æ–¹é¢æ˜¯è§£é¢˜æ€è·¯ä¼˜åŒ–ç­–ç•¥ç›˜ç‚¹å’Œå¯è¡Œæ€§åˆ†æï¼Œåˆ†æäº†baselineå·²ç»å…·å¤‡çš„ä¸€äº›ä¼˜åŒ–ç®—æ³•ï¼Œåˆ—ä¸¾äº†ä¸€äº›ä¸»æµçš„æ¨ç†ç­–ç•¥ï¼Œæ¯”å¦‚è¯´é‡åŒ–ç­–ç•¥å¯è¡Œæ€§åˆ†æï¼Œæ¯”å¦‚ é«˜æ•ˆçš„ç®—å­å®ç°ã€å’ŒæœåŠ¡è°ƒåº¦ç­–ç•¥ä¼˜åŒ–åˆ†æã€‚

å¦ä¸€æ–¹é¢å°±æ˜¯é’ˆå¯¹æœ¬æ¬¡æ¯”èµ›æ¨ç†è°ƒä¼˜èµ›é¢˜æ‰€åšçš„ä¼˜åŒ–ç­–ç•¥å®ç°æ–¹æ¡ˆçš„è¯´æ˜ã€‚

